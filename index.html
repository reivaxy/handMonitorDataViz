<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="css/handmonitor.css"/>


<body>
<h1 id="title" style="display:none"></h1>
<div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
    <div id="dragndrop">Faites glisser un fichier et lachez le dans cette zone</div>
    <div id="download">Téléchargez ce <a href="2020_07.csv"> fichier de test</a></div>
</div>
<div>
    <div class="graph">
        <div id="chart_placeholder">
        </div>
    </div>
</div>
</body>
<script src="js/jquery/jquery-3.5.1.min.js"></script>
<script src="js/d3/d3.min.js"></script>

<script>

    function dragOverHandler(ev) {
        ev.preventDefault();
    }

    function updateTitle(date) {
        let m = date.getMonth();
        let y = date.getFullYear();
        let month = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août",
            "Septembre", "Octobre", "Novembre", "Décembre"][m];
        $("#title").text("Données de " + month + " " + y);
        $("#title").show();
    }

    function processFile(file) {
        var reader = new FileReader();
        reader.onload = function (e) {
            let fileLines = e.target.result.split(/\r\n|\r|\n/);
            let dataSet = [];
            let previous = 0;
            for (i = 0; i < fileLines.length; i++) {
                let lineData = fileLines[i].split(',');
                // Compatibility with previous file format which was space separated
                if (lineData.length == 1) {
                    lineData = fileLines[i].split(' ');
                    let dDate = lineData.shift();
                    lineData[0] = dDate + " " + lineData[0];
                }
                let jData = {
                    date: parseDate(lineData[0]),
                    value: +lineData[1]
                }
                if(i == 0) {
                    updateTitle(jData.date);
                }
                if (i != 0 && previous != jData.value) {
                    dataSet.push({
                        date: parseDate(lineData[0]),
                        value: previous
                    })
                }
                previous = +lineData[1];
                dataSet.push(jData);
            }
            processData(dataSet);
        }
        reader.readAsText(file);
    }

    function dropHandler(ev) {
        console.log('File(s) dropped');
        $("#drop_zone").hide();
        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();

        if (ev.dataTransfer.items) {
            // Use DataTransferItemList interface to access the file(s)
            for (var i = 0; i < ev.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (ev.dataTransfer.items[i].kind === 'file') {
                    var file = ev.dataTransfer.items[i].getAsFile();
                    console.log('... file[' + i + '].name = ' + file.name);
                    if (file.type.indexOf("application/vnd.ms-excel") == 0 ||
                        file.type.indexOf("text/plain") == 0) {
                        processFile(file);
                    }
                }
            }
        } else {
            // Use DataTransfer interface to access the file(s)
            for (var i = 0; i < ev.dataTransfer.files.length; i++) {
                console.log('... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
                updateTitle(ev.dataTransfer.files[i].name);
                if (ev.dataTransfer.files[i].type.indexOf("application/vnd.ms-excel") == 0 ||
                    ev.dataTransfer.files[i].type.indexOf("text/plain") == 0) {
                    processFile(ev.dataTransfer.files[i]);
                }
            }
        }
    }

    var margin = {top: 10, right: 50, bottom: 100, left: 50},
        width =  window.innerWidth - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    var parseDate = d3.time.format("%d/%m/%Y %H:%M:%S").parse;

    var x = d3.time.scale().range([0, width]),
        y = d3.scale.linear().range([height, 0]);

    var xAxis = d3.svg.axis().scale(x).orient("bottom"),
        yAxis = d3.svg.axis().scale(y).orient("left");

    yAxis.tickFormat(function (d, i) {
        if (d == 1) return "porté"; else return "";
    });
    let defaultTick = x.tickFormat();
    xAxis.tickFormat(function (d, i) {
        let label = defaultTick(d, i).split(' ');
        let translation = label[0];
        switch (label[0]) {
            case "Mon":
                translation = "Lundi";
                break;
            case "Tue":
                translation = "Mardi";
                break;
            case "Wed":
                translation = "Mercredi";
                break;
            case "Thu":
                translation = "Jeudi";
                break;
            case "Fri":
                translation = "Vendredi";
                break;
            case "Sat":
                translation = "Samedi";
                break;
            case "Sun":
                translation = "Dimanche";
                break;

            // months
            case "January":
            case "Jan":
                translation = "Janvier";
                break;
            case "February":
            case "Feb":
                translation = "Février";
                break;
            case "March":
            case "Mar":
                translation = "Mars";
                break;
            case "April":
            case "Apr":
                translation = "Avril";
                break;
            case "May":
                translation = "Mai";
                break;
            case "June":
            case "Jun":
                translation = "Juin";
                break;
            case "July":
            case "Jul":
                translation = "Juillet";
                break;
            case "August":
            case "Aug":
                translation = "Août";
                break;
            case "September":
            case "Sep":
                translation = "Septembre";
                break;
            case "October":
            case "Oct":
                translation = "Octobre";
                break;
            case "November":
            case "Nov":
                translation = "Novembre";
                break;
            case "December":
            case "Dec":
                translation = "Décembre";
                break;
        }
        if (label[1]) {
            if(d.getDay() == 0) {
                return "Dim " + label[1] + " " + translation;
            } else {
                return translation + " " + label[1];
            }
        } else {
            return translation;
        }
    });

    var area = d3.svg.area()
        .x(function (d) {
            return x(d.date);
        })
        .y0(height)
        .y1(function (d) {
            return y(d.value);
        });

    var svg = d3.select("#chart_placeholder").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

    svg.append("defs").append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("width", width)
        .attr("height", height);

    var focus = svg.append("g")
        .attr("class", "focus")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var zoom = d3.behavior.zoom()
        .on("zoom", draw);
    // Add rect cover the zoomed graph and attach zoom event.
    var rect = svg.append("svg:rect")
        .attr("class", "pane")
        .attr("width", width)
        .attr("height", height)
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        .call(zoom);

    function processData(data) {
        x.domain(d3.extent(data.map(function (d) {
            return d.date;
        })));
        y.domain([0, d3.max(data.map(function (d) {
            return d.value;
        }))]);


        // Set up zoom behavior
        zoom.x(x);

        focus.append("path")
            .datum(data)
            .attr("class", "area")
            .attr("d", area);

        focus.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        focus.append("g")
            .attr("class", "y axis")
            .call(yAxis);

    }

    function draw() {
        focus.select(".area").attr("d", area);
        focus.select(".x.axis").call(xAxis);
    }

    function interpolateZoom(translate, scale, duration) {
        var self = this;
        return d3.transition().duration(duration).tween("zoom", function () {
            var iTranslate = d3.interpolate(zoom.translate(), translate),
                iScale = d3.interpolate(zoom.scale(), scale);
            return function (t) {
                zoom
                    .scale(iScale(t))
                    .translate(iTranslate(t));
                zoom.event(focus);
            };
        });
    }

</script>